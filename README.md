# ESP32-S3 Smart Home Control Panel

A feature-rich, touch-screen Smart Home Control Panel built for the **Waveshare ESP32-S3-Touch-LCD-4B**. This project integrates WiFi, MQTT (Home Assistant), Weather tracking, and Power Management into a sleek UI designed with SquareLine Studio and powered by LVGL.

**Please note:** some are work in progress **(WIP)**

## ğŸŒŸ Features

### ğŸ  Smart Home Control (MQTT)

* **Grid Control:** 9 dedicated switch buttons for common devices (Light, Fan, AC, Plug, TV, Bed, Lock, Heater, All). **(WIP)**
* **Bi-Directional Sync:** Updates UI state based on incoming MQTT messages and publishes commands immediately on touch. **(WIP)**
* **Customizable Topics:** MQTT Host, Port, Credentials, and Notification topics are fully configurable via the on-device Settings menu. **(WIP)**

### ğŸŒ¤ï¸ Weather & Location

The system uses a smart **Hybrid Location Strategy** to ensure weather and time data are always accurate, even after a reboot.

* **Dual-Mode Location:**
    * **Auto (IP-Based):** Automatically detects your city and coordinates using your WiFi's public IP via `ip-api.com`.
    * **Manual Override:** Search for any city globally using the built-in keyboard. The system uses the `open-meteo` Geocoding API to find the exact latitude/longitude.
* **Persistent Settings:** Your chosen location (whether Auto or Manual) is saved to the ESP32's non-volatile memory (NVS). The device wakes up knowing exactly where it is, without needing to re-fetch data immediately.
* **Live Weather:** Fetches real-time weather conditions from `open-meteo.com` (No API Key required).
* **Dynamic UI:** The home screen adapts to your environment:
    * **Conditions:** Visuals change for Clear, Rain, Snow, Clouds, Thunderstorms, and Fog.
    * **Day/Night Cycle:** Backgrounds automatically switch between Day and Night themes based on your location's local sunset/sunrise times.

### ğŸ”” Notification System

* **MQTT Alerts:** Receive text notifications directly from Home Assistant (via `ha/panel/notify`).
* **History Center:** Stores up to 15 recent notifications in a scrollable list.
* **Popup Actions:** Read details or delete individual alerts; "Clear All" functionality included.
* **Visual Indicators:** Home screen badge count for unread alerts.

### âš™ï¸ System & Connectivity

* **WiFi Manager:** On-screen WiFi scanning, password entry, and "Saved Networks" management (stores up to 5 networks).
* **Timekeeping:** Automatic NTP synchronization or Manual RTC (PCF85063) setting via keypad.
* **Persistence:** All settings (WiFi, MQTT, Device Name) are saved to Non-Volatile Storage (Preferences).

### ğŸ”‹ Power Management

* **Hardware Integration:** Full support for **AXP2101 PMU** to monitor battery percentage, voltage, and charging status.
* **Screensaver & Sleep:**
* *30 Seconds:* Dim screen/Show Screensaver (Clock & Weather).
* *60 Seconds:* Turn off backlight to save battery.
* *Wake:* Tap screen or shake device (IMU-based wake using QMI8658).

## ğŸ› ï¸ Hardware Specifications

* **Development Board:** [Waveshare ESP32-S3-Touch-LCD-4B](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-4B)
* **Display:** 4.0-inch IPS, 480x480 Resolution (RGB Interface)
* **Touch Controller:** GT911 (Capacitive)
* **Processor:** ESP32-S3-WROOM-1-N16R8 (XtensaÂ® 32-bit LX7)
* **Power Management:** AXP2101
* **IMU (Accelerometer/Gyro):** QMI8658C
* **RTC:** PCF85063
* **IO Expander:** XCA9554

---

## ğŸš€ Setup Guide

1. **Clone the Repository:** Download the project files.
2. **UI Files:** Ensure the `sleepscreen` folder (generated by SquareLine Studio) is in the same directory as your `libraries` folder.
3. **Install Libraries:** Use the Arduino Library Manager and Manual library configuration to install the dependencies listed below.
4. **Install Boards:** Use the Arduino Boards Manager to install the dependencies listed below.
5. **Compile & Upload:** Connect the board via USB-C and upload using the settings provided.
6. **On-Device Setup:**
    * Upon first boot, go to **Settings > WiFi Setup**.
    * Scan and Connect to your WiFi.
    * Go to **Settings > Home Assistant**.
    * Enter your MQTT Broker IP, Port (usually 1883), User, and Password.
    * Save Settings.

### ğŸ“¦ Library Installation

This project requires specific driver libraries provided by Waveshare to function correctly with the display, touch, and power management chips.

**Download Required Libraries:**
[ESP32-S3-Touch-LCD-4B Demo (Zip)](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-4B/ESP32-S3-Touch-LCD-4B-Demos.zip)

**Installation Steps:**

1. Download the ZIP file linked above.
2. Unzip the file.
3. Locate the `libraries` folder inside the unzipped directory.
4. Copy the contents of that `libraries` folder into your Arduino libraries directory (Usually `Documents/Arduino/libraries`).
    - *This installs: `Arduino_GFX`, `XPowersLib`, `SensorLib` (QMI8658/PCF85063), and `lvgl` configured for this board.*
5. **Additional Libraries:** If not included in the ZIP, install the following via the Arduino Library Manager:
    - `PubSubClient` by Nick O'Leary (v2.8)
    - `ArduinoJson` by Benoit Blanchon (v7.4.2)
6. **Boards:** Install the following via the Arduino Boards Manager:
    - `Arduino ESP32 Boards` by Arduino (v2.0.18-arduino.5)
    - `esp32` by Espressif Systems (v3.3.6)

### Arduino IDE Board Settings

| Setting | Value |
| --- | --- |
| **Board** | ESP32S3 Dev Module |
| **Port** | COMx / /dev/ttyUSBx |
| **USB CDC On Boot** | **Enabled** (Required for Serial) |
| **CPU Frequency** | 240MHz (WiFi) |
| **Core Debug Level** | None / Info |
| **Erase All Flash** | Disabled |
| **Events Run On** | Core 1 |
| **Flash Mode** | QIO 80MHz |
| **Flash Size** | 16MB (128Mb) |
| **JTAG Adapter** | Disabled |
| **Arduino Runs On** | Core 1 |
| **Partition Scheme** | **Custom** *Defined by partitions.csv* |
| **PSRAM** | **OPI PSRAM** (Crucial for 480x480 Display) |
| **Upload Speed** | 921600 |

### ğŸ’¾ Partitions Configuration

Due to the large size of the GUI assets, the default ESP32 partition scheme is insufficient. Created [partitions](partitions.csv) file to allocate 10MB for the application, ensuring enough space for LVGL images.

```csv
# Name,   Type, SubType, Offset,  Size, Flags
nvs,      data, nvs,     0x9000,  0x5000,
otadata,  data, ota,     0xe000,  0x2000,
app0,     app,  ota_0,   0x10000, 0xA00000,
spiffs,   data, spiffs,  0xA10000,0x5F0000,
```

### ğŸ”— MQTT Configuration (Home Assistant)

To integrate this panel with Home Assistant, add the following configuration to your `configuration.yaml` (or create Helpers) corresponding to the topics defined in the code.

**Payloads:** `ON` / `OFF`

| Switch Name | Command Topic (Set) | State Topic (Listen) |
| --- | --- | --- |
| **LIGHT** | `ha/panel/light/set` | `ha/panel/light/state` |
| **FAN** | `ha/panel/fan/set` | `ha/panel/fan/state` |
| **AC** | `ha/panel/ac/set` | `ha/panel/ac/state` |
| **PLUG** | `ha/panel/plug/set` | `ha/panel/plug/state` |
| **TV** | `ha/panel/tv/set` | `ha/panel/tv/state` |
| **BED** | `ha/panel/bed/set` | `ha/panel/bed/state` |
| **LOCK** | `ha/panel/lock/set` | `ha/panel/lock/state` |
| **HEAT** | `ha/panel/heat/set` | `ha/panel/heat/state` |
| **ALL** | `ha/panel/all/set` | `ha/panel/all/state` |

### Sending Notifications

To send a notification to the panel from Home Assistant, publish a message to the configured notification topic (Default: `ha/panel/notify`).

* **Topic:** `ha/panel/notify`
* **Payload:** `Front Door is Open`

---
### ğŸ” Troubleshooting
- **Screen is black but code is running:** Ensure PSRAM is set to OPI PSRAM. The 480x480 frame buffer requires OPI PSRAM to initialize the RGB interface.
- **Compilation Error:** 'class Arduino_RGB_Display' has no member named 'Display_Brightness'.
  - **Fix:** This project uses a custom driver implementation. Ensure you have copied the libraries folder from the Waveshare Demo zip specifically into your Arduino libraries folder.
- **Backlight Control:** The backlight is controlled via the AXP2101 PMU (DLDO1). Standard analogWrite on a GPIO will not work.

### ğŸ¨ [Assets](assets/) & UI Resources

The project includes an `assets` folder containing the graphical elements used to design the interface in SquareLine Studio. These images are compiled directly into the source code (referenced in `ui.h`) during the export process.

### Folder Structure

```text
assets/
â”œâ”€â”€ scenes/   # Background PNGs used for the Screensaver (Sleep Screen)
â”‚   â”œâ”€â”€ clear_day.png
â”‚   â”œâ”€â”€ clear_night.png
â”‚   â”œâ”€â”€ rain_day.png
â”‚   â”œâ”€â”€ snow_night.png
â”‚   â””â”€â”€ ... (Dynamic backgrounds based on weather conditions)
â”‚
â””â”€â”€ weather/  # PNG Icons representing specific weather statuses
    â”œâ”€â”€ weather_day.png
    â”œâ”€â”€ weather_cloudy.png
    â”œâ”€â”€ weather_rain.png
    â”œâ”€â”€ weather_storm.png
    â””â”€â”€ ... (Icons updated via Open-Meteo API data)

```

### Integration Note

In **SquareLine Studio**, these assets were imported to create the image widgets (`ui_uiImgBg` and `ui_uiIconWeather`). The C array definitions for these images are automatically generated in the exported `ui_img_...c` files, allowing the ESP32 to render them without an external SD card.

*Images used in screensaver backdrop are generaed using Google Gemini*

---

## Project Gallery

<table align="center">
  <tr>
    <td align="center">
      <img src="docs/screenshots/nodata_screen.png" width="220"/><br/>
      <sub>NoData Screen</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/screensaver.jpeg" width="220"/><br/>
      <sub>Screen Saver</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/settings_home.jpeg" width="220"/><br/>
      <sub>Settings Page</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/housing.jpeg" width="220"/><br/>
      <sub>Housing</sub>
    </td>
  </tr>
  <tr>
    <td align="center">
      <img src="docs/screenshots/HA_screen.jpeg" width="220"/><br/>
      <sub>HA Screen</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/notifications.jpeg" width="220"/><br/>
      <sub>Notifications Screen</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/wifi_settings.jpeg" width="220"/><br/>
      <sub>WiFi Settings</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/HA_settings.jpeg" width="220"/><br/>
      <sub>HA Settings</sub>
    </td>
  </tr>
  <tr>
    <td align="center">
      <img src="docs/screenshots/date_time.jpeg" width="220"/><br/>
      <sub>Date/Time Screen</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/location_screen.jpeg" width="220"/><br/>
      <sub>Location Screen</sub>
    </td>
    <td align="center">
      <img src="docs/screenshots/system_status.jpeg" width="220"/><br/>
      <sub>System Status</sub>
    </td>
     <td align="center">
      <img src="docs/screenshots/about.jpeg" width="220"/><br/>
      <sub>About Page</sub>
    </td>
  </tr>
</table>


---

## ğŸ“ Credits & References

* **Board Manufacturer:** [Waveshare](https://www.waveshare.com/)
* **UI Design:** [SquareLine Studio](https://squareline.io/)
* **Graphics Library:** [LVGL](https://lvgl.io/)
* **Weather Data:** [Open-Meteo](https://open-meteo.com/)
* **Location Data:** [IP-API](https://ip-api.com/)